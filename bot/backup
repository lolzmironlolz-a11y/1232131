import asyncio
import logging
import sqlite3
from datetime import datetime
from aiogram.utils.media_group import MediaGroupBuilder

from aiogram import Bot, Dispatcher, Router, types, F
from aiogram.enums import ContentType
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
from aiogram import Bot

# ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ =====
API_TOKEN = "7983099837:AAHlEED1Cc2BVpP6o1La7869yn17F59O4a8"
DB_PATH = "users.db"
ADMINS = [7790817100]  # ID –∞–¥–º–∏–Ω–æ–≤
bot = Bot(token=API_TOKEN)

# ===== –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ =====
logging.basicConfig(level=logging.INFO)

# ===== –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã =====
def main_kb():
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ü—Ä–æ—Ñ–∏–ª—å")],
            [KeyboardButton(text="–ü–æ–º–æ—â—å")],
            [KeyboardButton(text="–ó–∞–¥–∞—á–∏")]
        ],
        resize_keyboard=True
    )
    return kb

kb_contact = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º", request_contact=True)]],
    resize_keyboard=True,
    one_time_keyboard=True
)

# ===== –ë–î =====
def init_db():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        phone TEXT,
        fio TEXT,
        district TEXT,
        registered_at TEXT
    )
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS tasks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        description TEXT,
        created_at TEXT
    )
    """)
    cur.execute("""
    CREATE TABLE IF NOT EXISTS user_tasks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        task_id INTEGER,
        status TEXT,
        photo TEXT,
        video TEXT,
        missing_text TEXT
    )
    """)
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
    cur.execute("""
    CREATE TABLE IF NOT EXISTS done_tasks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        task_id INTEGER,
        description TEXT,
        photo TEXT,
        video TEXT,
        missing_text TEXT,
        completed_at TEXT
    )
    """)
    conn.commit()
    conn.close()


def save_partial_contact(user_id: int, phone: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "INSERT OR IGNORE INTO users(user_id, phone, registered_at) VALUES(?, ?, ?)",
        (user_id, phone, datetime.utcnow().isoformat())
    )
    cur.execute("UPDATE users SET phone = ? WHERE user_id = ?", (phone, user_id))
    conn.commit()
    conn.close()

def save_full_profile(user_id: int, fio: str, district: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("UPDATE users SET fio = ?, district = ? WHERE user_id = ?", (fio, district, user_id))
    conn.commit()
    conn.close()

def get_user(user_id: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT phone, fio, district, registered_at FROM users WHERE user_id = ?", (user_id,))
    row = cur.fetchone()
    conn.close()
    return row

def is_registered(user_id: int) -> bool:
    row = get_user(user_id)
    return bool(row and row[0] and row[1])

def add_task(description: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("INSERT INTO tasks(description, created_at) VALUES(?, ?)", (description, datetime.utcnow().isoformat()))
    conn.commit()
    conn.close()

def get_tasks():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT id, description FROM tasks")
    rows = cur.fetchall()
    conn.close()
    return rows

# ===== FSM =====
class RegStates(StatesGroup):
    waiting_contact = State()
    waiting_fio = State()
    waiting_district = State()

class TaskCreate(StatesGroup):
    waiting_description = State()

class TaskWork(StatesGroup):
    waiting_media = State()
    waiting_missing_text = State()

class SearchUser(StatesGroup):
    waiting_query = State()

# ===== Router =====
router = Router()

# ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è =====
@router.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    uid = message.from_user.id
    if is_registered(uid):
        await message.answer("–¢—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=main_kb())
        return
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏—à–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç:", reply_markup=kb_contact)
    await state.set_state(RegStates.waiting_contact)

@router.message(RegStates.waiting_contact, F.content_type == ContentType.CONTACT)
async def contact_handler(message: types.Message, state: FSMContext):
    phone = message.contact.phone_number
    uid = message.from_user.id
    save_partial_contact(uid, phone)
    await message.answer("–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Å–≤–æ—ë –§–ò–û:", reply_markup=ReplyKeyboardRemove())
    await state.set_state(RegStates.waiting_fio)

@router.message(RegStates.waiting_fio)
async def fio_handler(message: types.Message, state: FSMContext):
    fio = message.text.strip()
    await state.update_data(fio=fio)
    await message.answer("–ù–∞–ø–∏—à–∏ —Ä–∞–π–æ–Ω –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è:")
    await state.set_state(RegStates.waiting_district)

@router.message(RegStates.waiting_district)
async def district_handler(message: types.Message, state: FSMContext):
    data = await state.get_data()
    save_full_profile(message.from_user.id, data["fio"], message.text.strip())
    await state.clear()
    await message.answer("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", reply_markup=main_kb())


# ===== –ê–¥–º–∏–Ω =====
@router.message(Command("admin"), F.from_user.id.in_(ADMINS))
async def admin_menu(message: types.Message):
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É")],
            [KeyboardButton(text="‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏")],
            [KeyboardButton(text="üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ")],
            [KeyboardButton(text="üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")],
            [KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")],
        ],
        resize_keyboard=True
    )
    await message.answer("–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:", reply_markup=kb)

# ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
@router.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", F.from_user.id.in_(ADMINS))
async def add_task_start(message: types.Message, state: FSMContext):
    await message.answer("–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:", reply_markup=ReplyKeyboardRemove())
    await state.set_state(TaskCreate.waiting_description)


@router.message(TaskCreate.waiting_description, F.from_user.id.in_(ADMINS))
async def add_task_finish(message: types.Message, state: FSMContext, bot: Bot):
    add_task(message.text.strip())
    await state.clear()
    await message.answer("–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!", reply_markup=main_kb())

    # –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT user_id FROM users")
    users = cur.fetchall()
    conn.close()
    for uid, in users:
        if uid not in ADMINS:
            try:
                await bot.send_message(uid, f"üì¢ –ü–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞:\n{message.text}")
            except:
                pass


@router.message(F.text == "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏", F.from_user.id.in_(ADMINS))
async def show_completed_tasks(message: types.Message):
    rows = get_done_tasks()

    if not rows:
        await message.answer("‚úÖ –ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=f"{desc} ({fio})", callback_data=f"done_{done_id}")]
            for done_id, desc, fio in rows
        ]
    )
    await message.answer("üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:", reply_markup=kb)


@router.callback_query(F.data.startswith("done_"), F.from_user.id.in_(ADMINS))
async def show_done_task_details(callback: types.CallbackQuery):
    done_task_id = int(callback.data.split("_")[1])
    details = get_done_task_details(done_task_id)
    if not details:
        await callback.message.answer("‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    description, fio, photo, video, missing_text = details
    text = f"üìù –ó–∞–¥–∞—á–∞: {description}\nüë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {fio}\nüìå –ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ: {missing_text}"
    await callback.message.answer(text)

    if photo:
        await callback.message.answer_photo(photo)
    if video:
        await callback.message.answer_video(video)

# --- –ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ ---
@router.message(F.text == "üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏", F.from_user.id.in_(ADMINS))
async def delete_done_tasks_menu(message: types.Message):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –£–¥–∞–ª–∏—Ç—å –≤—Å–µ", callback_data="confirm_delete_all_done")],
        [InlineKeyboardButton(text="üìù –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ", callback_data="delete_select_done")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="delete_cancel")]
    ])
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏:", reply_markup=kb)


# --- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö ---
@router.callback_query(F.data == "confirm_delete_all_done", F.from_user.id.in_(ADMINS))
async def confirm_delete_all(callback: types.CallbackQuery):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ö†Ô∏è –î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å–µ", callback_data="delete_all_done")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="delete_cancel")]
    ])
    await callback.message.edit_text("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?", reply_markup=kb)


# --- –£–¥–∞–ª–∏—Ç—å –≤—Å–µ ---
@router.callback_query(F.data == "delete_all_done", F.from_user.id.in_(ADMINS))
async def delete_all_done_tasks(callback: types.CallbackQuery):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("DELETE FROM done_tasks")
    conn.commit()
    conn.close()
    await callback.message.edit_text("‚úÖ –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã.")


# --- –í—ã–±–æ—Ä–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ ---
@router.callback_query(F.data == "delete_select_done", F.from_user.id.in_(ADMINS))
async def select_done_tasks_for_deletion(callback: types.CallbackQuery):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        SELECT id, description,
               (SELECT fio FROM users WHERE user_id = done_tasks.user_id) as fio
        FROM done_tasks
        ORDER BY completed_at DESC
    """)
    rows = cur.fetchall()
    conn.close()

    if not rows:
        await callback.message.edit_text("–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=f"{desc} ({fio})", callback_data=f"delete_done_{done_id}")]
            for done_id, desc, fio in rows
        ]
    )
    await callback.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=kb)


# --- –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π ---
@router.callback_query(F.data.startswith("delete_done_"), F.from_user.id.in_(ADMINS))
async def delete_specific_done(callback: types.CallbackQuery):
    done_id = int(callback.data.split("_")[2])
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("DELETE FROM done_tasks WHERE id = ?", (done_id,))
    conn.commit()
    conn.close()
    await callback.answer("–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞ ‚úÖ", show_alert=False)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        SELECT id, description,
               (SELECT fio FROM users WHERE user_id = done_tasks.user_id) as fio
        FROM done_tasks
        ORDER BY completed_at DESC
    """)
    rows = cur.fetchall()
    conn.close()

    if not rows:
        await callback.message.edit_text("–í—Å–µ –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã ‚úÖ")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=f"{desc} ({fio})", callback_data=f"delete_done_{done_id}")]
            for done_id, desc, fio in rows
        ]
    )
    await callback.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=kb)


# --- –û—Ç–º–µ–Ω–∞ ---
@router.callback_query(F.data == "delete_cancel", F.from_user.id.in_(ADMINS))
async def cancel_delete_done(callback: types.CallbackQuery):
    await callback.message.edit_text("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

# --- –ó–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞ ---
@router.message(F.text == "üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", F.from_user.id.in_(ADMINS))
async def start_search(message: types.Message, state: FSMContext):
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:", reply_markup=ReplyKeyboardRemove())
    await state.set_state(SearchUser.waiting_query)


# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ ---
@router.message(SearchUser.waiting_query, F.from_user.id.in_(ADMINS))
async def process_search(message: types.Message, state: FSMContext):
    query = message.text.strip()
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        SELECT user_id, fio, phone, district
        FROM users
        WHERE fio LIKE ? OR phone LIKE ?
    """, (f"%{query}%", f"%{query}%"))
    results = cur.fetchall()
    conn.close()

    await state.clear()

    if not results:
        await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", reply_markup=main_kb())
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    for user_id, fio, phone, district in results:
        await message.answer(
            f"üë§ <b>–ü—Ä–æ—Ñ–∏–ª—å</b>\n"
            f"üÜî ID: <code>{user_id}</code>\n"
            f"üìõ –§–ò–û: {fio}\n"
            f"üì± –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
            f"üìç –†–∞–π–æ–Ω: {district}",
            parse_mode="HTML",
            reply_markup=main_kb()
        )

# ===== –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å =====

@router.message(F.text == "–ü–æ–º–æ—â—å")
async def help_handler(message: types.Message):
    await message.answer("–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ª–∏–±–æ —Å–≤—è–∂–∏—Å—å —Å –∞–¥–º–∏–Ω–æ–º.")

@router.message(F.text == "–ü—Ä–æ—Ñ–∏–ª—å")
async def show_profile(message: types.Message):
    uid = message.from_user.id
    row = get_user(uid)
    if not row:
        await message.answer("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è: /start", reply_markup=ReplyKeyboardRemove())
        return
    phone, fio, district, reg_at = row
    await message.answer(
        f"üë§ <b>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üìõ <b>–§–ò–û:</b> {fio}\n"
        f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {phone}\n"
        f"üìç <b>–†–∞–π–æ–Ω:</b> {district}\n"
        f"üóì <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</b> {reg_at}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        parse_mode="HTML"
    )
@router.message(F.text == "–ó–∞–¥–∞—á–∏")
async def show_tasks(message: types.Message):
    tasks = get_tasks()
    if not tasks:
        await message.answer("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á.")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=desc, callback_data=f"take_{tid}")]
            for tid, desc in tasks
        ]
    )

    await message.answer("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏:", reply_markup=kb)




# ===== –î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ =====
def save_done_task(user_id, task_id, description, photo=None, video=None, missing_text=None):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        INSERT INTO done_tasks (user_id, task_id, description, photo, video, missing_text, completed_at)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (user_id, task_id, description, photo, video, missing_text, datetime.utcnow().isoformat()))
    conn.commit()
    conn.close()

def get_done_tasks():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        SELECT id, description,
               (SELECT fio FROM users WHERE user_id = done_tasks.user_id) as fio
        FROM done_tasks
        ORDER BY completed_at DESC
    """)
    rows = cur.fetchall()
    conn.close()
    return rows

def get_done_task_details(done_task_id: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        SELECT description,
               (SELECT fio FROM users WHERE user_id = done_tasks.user_id) as fio,
               photo, video, missing_text
        FROM done_tasks
        WHERE id = ?
    """, (done_task_id,))
    row = cur.fetchone()
    conn.close()
    return row


# ===== –ê–¥–º–∏–Ω: –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á =====
@router.message(F.text == "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏", F.from_user.id.in_(ADMINS))
async def view_done_tasks(message: types.Message):
    tasks = get_done_tasks()
    if not tasks:
        await message.answer("–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.")
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=f"{desc} ({fio})", callback_data=f"done_{done_id}")]
            for done_id, desc, fio in tasks
        ]
    )
    await message.answer("–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:", reply_markup=kb)


@router.callback_query(F.data.startswith("done_"), F.from_user.id.in_(ADMINS))
async def show_done_task_details(callback: types.CallbackQuery):
    done_task_id = int(callback.data.split("_")[1])
    details = get_done_task_details(done_task_id)
    if not details:
        await callback.message.answer("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    description, fio, photo, video, missing_text = details
    await callback.message.answer(f"–ó–∞–¥–∞—á–∞: {description}\n–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {fio}\n–ß–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ: {missing_text}")

    if photo:
        await callback.message.answer_photo(photo)
    if video:
        await callback.message.answer_video(video)


# ===== –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ =====
@router.callback_query(F.data.startswith("take_"))
async def take_task(callback: types.CallbackQuery, state: FSMContext):
    task_id = int(callback.data.split("_")[1])

    # –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT description FROM tasks WHERE id = ?", (task_id,))
    row = cur.fetchone()
    conn.close()

    if not row:
        await callback.message.answer("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    desc = row[0]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ FSMContext
    await state.update_data(task_id=task_id, description=desc)

    await callback.message.answer("–í—ã –≤–∑—è–ª–∏ –∑–∞–¥–∞—á—É –≤ —Ä–∞–±–æ—Ç—É. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ –∫–∞–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ.")
    await state.set_state(TaskWork.waiting_media)


@router.message(TaskWork.waiting_media, F.content_type.in_({"photo", "video"}))
async def task_media(message: types.Message, state: FSMContext):
    if message.photo:
        file_id = message.photo[-1].file_id
        await state.update_data(photo=file_id)
    elif message.video:
        file_id = message.video.file_id
        await state.update_data(video=file_id)

    await message.answer("–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ, —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–µ.")
    await state.set_state(TaskWork.waiting_missing_text)


@router.message(TaskWork.waiting_missing_text)
async def task_missing(message: types.Message, state: FSMContext):
    data = await state.get_data()
    task_id = data.get("task_id")
    description = data.get("description")
    photo = data.get("photo")
    video = data.get("video")
    missing_text = message.text.strip()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
    save_done_task(message.from_user.id, task_id, description, photo, video, missing_text)

    # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ —Å–ø–∏—Å–∫–∞
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("DELETE FROM tasks WHERE id = ?", (task_id,))
    conn.commit()
    conn.close()

    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_info = get_user(message.from_user.id)
    fio = user_info[1] if user_info else message.from_user.full_name

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)
    for admin_id in ADMINS:
        await message.bot.send_message(
            admin_id,
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {fio} (ID: {message.from_user.id}) –≤—ã–ø–æ–ª–Ω–∏–ª –∑–∞–¥–∞—á—É:\nüìå {description}"
        )

    await state.clear()
    await message.answer("‚úÖ –í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞—á—É!", reply_markup=main_kb())


# ===== Main =====
async def main():
    init_db()
    bot = Bot(token=API_TOKEN)
    dp = Dispatcher(storage=MemoryStorage())
    dp.include_router(router)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())












#–ó–∞–¥–∞—á–∏

from aiogram import Router, types, F
from aiogram.fsm.context import FSMContext
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from bot.states import TaskCreate, TaskWork
from bot.db import add_task, get_tasks, save_done_task, get_user
from bot.keyboards import main_kb
import sqlite3
from aiogram_media_group import media_group_handler
from bot.config import DB_PATH, ADMINS
from aiogram import Bot
from bot.config import API_TOKEN

bot = Bot(token=API_TOKEN)
router = Router()
ADMINS = [7790817100]  # –ú–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ config

# ===== –§—É–Ω–∫—Ü–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç—ã –∏ –±–æ–Ω—É—Å–æ–≤ =====
def add_salary(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS user_stats (
            user_id INTEGER PRIMARY KEY,
            total_salary INTEGER DEFAULT 0,
            total_bonus INTEGER DEFAULT 0
        )
    """)
    cur.execute("""
        INSERT INTO user_stats(user_id, total_salary) VALUES(?, ?)
        ON CONFLICT(user_id) DO UPDATE SET total_salary = total_salary + ?
    """, (user_id, amount, amount))
    conn.commit()
    conn.close()

def add_bonus(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS user_stats (
            user_id INTEGER PRIMARY KEY,
            total_salary INTEGER DEFAULT 0,
            total_bonus INTEGER DEFAULT 0
        )
    """)
    cur.execute("""
        INSERT INTO user_stats(user_id, total_bonus) VALUES(?, ?)
        ON CONFLICT(user_id) DO UPDATE SET total_bonus = total_bonus + ?
    """, (user_id, amount, amount))
    conn.commit()
    conn.close()

# ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∞–¥–º–∏–Ω–æ–º
@router.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", F.from_user.id.in_(ADMINS))
async def add_task_start(message: types.Message, state: FSMContext):
    await message.answer("–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:", reply_markup=ReplyKeyboardRemove())
    await state.set_state(TaskCreate.waiting_description)

@router.message(TaskCreate.waiting_description, F.from_user.id.in_(ADMINS))
async def add_task_finish(message: types.Message, state: FSMContext):
    add_task(message.text.strip())
    await state.clear()
    await message.answer("–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!", reply_markup=main_kb())

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
@router.message(F.text == "–ó–∞–¥–∞—á–∏")
async def show_tasks(message: types.Message):
    tasks = get_tasks()
    if not tasks:
        await message.answer(
            "üòî <b>–£–ø—Å!</b>\n"
            "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.\n\n"
            "üìå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞.",
            parse_mode="HTML"
        )
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(
                text=f"{addr} | {title}",
                callback_data=f"take_{tid}"
            )]
            for tid, title, desc, safe_code, comment, addr in tasks
        ]
    )

    await message.answer(
        "üöÄ –ì–æ—Ç–æ–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é?\n\n"
        "–í–æ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç –≤–∞—à–µ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞:\n"
        "üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∑–∞–¥–∞—á—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –µ—ë –≤ —Ä–∞–±–æ—Ç—É –∏ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–Ω—É—Å—ã!",
        reply_markup=kb
    )

# –í–∑—è—Ç–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç—É
@router.callback_query(F.data.startswith("take_"))
async def take_task(callback: types.CallbackQuery, state: FSMContext):
    task_id = int(callback.data.split("_")[1])
    tasks = get_tasks()
    task = next((t for t in tasks if t[0] == task_id), None)

    if not task:
        await callback.message.answer("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
    tid, title, desc, safe_code, comment, addr = task

    await state.update_data(
        task_id=tid,
        address=addr or "–ù–µ —É–∫–∞–∑–∞–Ω",
        description=desc or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è",
        safe_code=safe_code or "",
        comment=comment or ""
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    msg = f"‚úÖ <b>–í—ã –≤–∑—è–ª–∏ –∑–∞–¥–∞—á—É –≤ —Ä–∞–±–æ—Ç—É</b>\n\n" \
          f"üè† <b>–ê–¥—Ä–µ—Å:</b> {addr or '-'}\n" \
          f"üìù <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {desc or '-'}\n"

    if safe_code:
        msg += f"üîê <b>–ö–æ–¥ –æ—Ç —Å–µ–π—Ñ–∞:</b> {safe_code}\n"
    if comment:
        msg += f"üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –∞–¥–º–∏–Ω–∞:</b> {comment}\n"

    await callback.message.answer(msg, parse_mode="HTML")
    await callback.answer()  # —É–±–∏—Ä–∞–µ—Ç "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

    await callback.message.answer("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ –∫–∞–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.")
    await state.set_state(TaskWork.waiting_media)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ª—å–±–æ–º–æ–≤ (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)
@router.message(TaskWork.waiting_media, F.media_group_id)
@media_group_handler
async def handle_album(messages: list[types.Message], state: FSMContext):
    photos, videos = [], []
    for msg in messages:
        if msg.photo:
            photos.append(msg.photo[-1].file_id)
        elif msg.video:
            videos.append(msg.video.file_id)

    await state.update_data(photos=photos, videos=videos)
    await messages[0].answer("‚úèÔ∏è –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ, —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–µ.")
    await state.set_state(TaskWork.waiting_missing_text)

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –ø–æ –æ–¥–Ω–æ–º—É
@router.message(TaskWork.waiting_media, F.content_type.in_({"photo", "video"}))
async def task_media(message: types.Message, state: FSMContext):
    data = {}
    if message.photo:
        data["photos"] = [message.photo[-1].file_id]
    elif message.video:
        data["videos"] = [message.video.file_id]

    if data:
        await state.update_data(**data)

    await message.answer("‚úèÔ∏è –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ, —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ –∫–≤–∞—Ä—Ç–∏—Ä–µ.")
    await state.set_state(TaskWork.waiting_missing_text)

# –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
@router.message(TaskWork.waiting_missing_text)
async def task_missing(message: types.Message, state: FSMContext):
    data = await state.get_data()
    task_id = data.get("task_id")
    description = data.get("description")
    photos = data.get("photos", [])
    videos = data.get("videos", [])
    missing_text = message.text.strip()

    save_done_task(message.from_user.id, task_id, description, photos, videos, missing_text)
    add_salary(message.from_user.id, 400)
    add_bonus(message.from_user.id, 10)

    # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏–∑ –ë–î
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("DELETE FROM tasks WHERE id = ?", (task_id,))
    conn.commit()
    conn.close()

    user_info = get_user(message.from_user.id)
    fio = user_info[1] if user_info else message.from_user.full_name

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤
    for admin_id in ADMINS:
        await message.bot.send_message(
            admin_id,
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {fio} (ID: {message.from_user.id}) –≤—ã–ø–æ–ª–Ω–∏–ª –∑–∞–¥–∞—á—É:\nüìå {description}"
        )

    await state.clear()
    await message.answer("‚úÖ –í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞—á—É! –ù–∞—á–∏—Å–ª–µ–Ω–æ 400 ‚ÇΩ –∏ 10 –±–æ–Ω—É—Å–æ–≤.", reply_markup=main_kb())



–∑–∞–¥–∞—á–∏

from aiogram import Router, types, F
from aiogram.fsm.context import FSMContext
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardRemove
from bot.states import TaskCreate, TaskWork
from bot.db import add_task_with_address as add_task, get_tasks, save_done_task, get_user
from bot.keyboards import main_kb
import sqlite3
from bot.db import add_task_with_address
from aiogram_media_group import media_group_handler
from bot.config import DB_PATH, ADMINS
from aiogram import Bot
import time
from bot.config import API_TOKEN

bot = Bot(token=API_TOKEN)
router = Router()
ADMINS = [7790817100]  # –ú–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ config

# ===== –§—É–Ω–∫—Ü–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç—ã –∏ –±–æ–Ω—É—Å–æ–≤ =====
def add_salary(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS user_stats (
            user_id INTEGER PRIMARY KEY,
            total_salary INTEGER DEFAULT 0,
            total_bonus INTEGER DEFAULT 0
        )
    """)
    cur.execute("""
        INSERT INTO user_stats(user_id, total_salary) VALUES(?, ?)
        ON CONFLICT(user_id) DO UPDATE SET total_salary = total_salary + ?
    """, (user_id, amount, amount))
    conn.commit()
    conn.close()

def add_bonus(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS user_stats (
            user_id INTEGER PRIMARY KEY,
            total_salary INTEGER DEFAULT 0,
            total_bonus INTEGER DEFAULT 0
        )
    """)
    cur.execute("""
        INSERT INTO user_stats(user_id, total_bonus) VALUES(?, ?)
        ON CONFLICT(user_id) DO UPDATE SET total_bonus = total_bonus + ?
    """, (user_id, amount, amount))
    conn.commit()
    conn.close()

# ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∞–¥–º–∏–Ω–æ–º
@router.message(F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É", F.from_user.id.in_(ADMINS))
async def add_task_start(message: types.Message, state: FSMContext):
    await message.answer("–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:", reply_markup=ReplyKeyboardRemove())
    await state.set_state(TaskCreate.waiting_description)

@router.message(TaskCreate.waiting_description, F.from_user.id.in_(ADMINS))
async def add_task_finish(message: types.Message, state: FSMContext):
    add_task(message.text.strip())
    await state.clear()
    await message.answer("–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!", reply_markup=main_kb())

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
@router.message(F.text == "–ó–∞–¥–∞—á–∏")
async def show_tasks(message: types.Message):
    tasks = get_tasks()
    if not tasks:
        await message.answer(
            "üòî <b>–£–ø—Å!</b>\n"
            "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.\n\n"
            "üìå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞.",
            parse_mode="HTML"
        )
        return

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(
                text=f"{addr_id}",  # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å
                callback_data=f"take_{tid}"
            )]
            for tid, title, desc, safe_code, comment, addr_id, *rest in tasks
        ]
    )

    await message.answer(
        "üöÄ –ì–æ—Ç–æ–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é?\n\n"
        "–í–æ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç –≤–∞—à–µ–≥–æ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞:\n"
        "üí° –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∑–∞–¥–∞—á—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –µ—ë –≤ —Ä–∞–±–æ—Ç—É –∏ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–Ω—É—Å—ã!",
        reply_markup=kb
    )

# –í–∑—è—Ç–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç—É
@router.callback_query(F.data.startswith("take_"))
async def take_task(callback: types.CallbackQuery, state: FSMContext):
    task_id = int(callback.data.split("_")[1])
    tasks = get_tasks()
    task = next((t for t in tasks if t[0] == task_id), None)

    if not task:
        await callback.message.answer("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    tid, title, desc, safe_code, comment, addr_id, *rest = task  # addr_id - id –∞–¥—Ä–µ—Å–∞

    # –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å, —ç—Ç–∞–∂ –∏ –∫–≤–∞—Ä—Ç–∏—Ä—É
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT title, floor, apartment FROM addresses WHERE id = ?", (addr_id,))
    row = cur.fetchone()
    conn.close()

    if row:
        address, floor, apartment = row
        address = address if address else "–ù–µ —É–∫–∞–∑–∞–Ω"
        floor = floor if floor else "–ù–µ —É–∫–∞–∑–∞–Ω"
        apartment = apartment if apartment else "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
    else:
        address = floor = apartment = "–ù–µ —É–∫–∞–∑–∞–Ω"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë –≤ state
    await state.update_data(
        task_id=tid,
        address=address,
        floor=floor,
        apartment=apartment,
        description=desc or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è",
        safe_code=safe_code or "",
        comment=comment or "",
        taken_time=time.time()
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    msg = (
        "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n"
        "‚úÖ <b>–í—ã –≤–∑—è–ª–∏ –∑–∞–¥–∞—á—É –≤ —Ä–∞–±–æ—Ç—É</b>\n"
        "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n"
        f"üè† <b>–ê–¥—Ä–µ—Å:</b> {address}\n"
        f"‚¨ÜÔ∏è <b>–≠—Ç–∞–∂:</b> {floor}\n"
        f"üè¢ <b>–ö–≤–∞—Ä—Ç–∏—Ä–∞:</b> {apartment}\n"
        f"üìù <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {desc or '-'}\n"
    )

    if safe_code:
        msg += f"üîê <b>–ö–æ–¥ –æ—Ç —Å–µ–π—Ñ–∞:</b> {safe_code}\n"
    if comment:
        msg += f"üí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –∞–¥–º–∏–Ω–∞:</b> {comment}\n"

    await callback.message.answer(msg, parse_mode="HTML")

    await callback.answer()
    await callback.message.answer(
        "üì∏ <b>–ü–æ—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ!</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>—Ñ–æ—Ç–æ</b> –∏ <b>–≤–∏–¥–µ–æ</b>, —á—Ç–æ–±—ã –¥–æ–∫–∞–∑–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏.",
        parse_mode="HTML"
    )
    await state.set_state(TaskWork.waiting_media)

mine.py


import asyncio
import logging
import logging.handlers
from aiogram import BaseMiddleware
from aiogram import Bot, Dispatcher, types, F
from aiogram.fsm.storage.memory import MemoryStorage

from config import API_TOKEN
from db import init_db, update_tasks_table, migrate_tasks_safe_code, migrate_addresses_table, migrate_tasks_add_executor
from handlers import registration, admin, tasks, profile

# ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤ ====
logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s | %(levelname)s | %(name)s | %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S",
)
logger = logging.getLogger(__name__)

# ==== –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î ====
init_db()
migrate_tasks_safe_code()
migrate_addresses_table()
migrate_tasks_add_executor()
update_tasks_table()


class ErrorLoggingMiddleware(BaseMiddleware):
    async def __call__(self, handler, event, data):
        try:
            return await handler(event, data)
        except Exception:
            logger.exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è: {event}")
            raise

async def main():
    bot = Bot(token=API_TOKEN)
    dp = Dispatcher(storage=MemoryStorage())

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
    dp.include_router(registration.router)
    dp.include_router(admin.router)
    dp.include_router(tasks.router)
    dp.include_router(profile.router)


    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∏–¥–ª–≤–∞—Ä–∏
    dp.message.middleware(ErrorLoggingMiddleware())
    dp.callback_query.middleware(ErrorLoggingMiddleware())

    # ==== DEBUG –ª–æ–≤—É—à–∫–∏ ====

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º polling...")

    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.exception(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ polling: {e}")
    finally:
        await bot.session.close()
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


handler = logging.handlers.RotatingFileHandler(
    "bot.log", maxBytes=5_000_000, backupCount=5, encoding="utf-8"
)
logging.getLogger().addHandler(handler)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é")